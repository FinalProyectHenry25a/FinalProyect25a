const { Order_detail, Order } = require("../db.js");

const { PROD_ACCESS_TOKEN } = process.env;

const router = require("express").Router();

// SDK de Mercado Pago
const mercadopago = require("mercadopago");
// const { route } = require('./order');

mercadopago.configure({
  access_token: PROD_ACCESS_TOKEN,
});

router.post('/', async(req, res, next) => {
  try {
    const {email,items}=req.body
    const preference = {
      auto_return: "approved",
      external_reference: 'orderId',
      items: items,
      payer: {
          name: "user-name",
          surname: "user-surname",
          email: email,
          date_created: "",
          phone: {
              area_code: '11',
              number: 4444-4444
          },
          identification: {
              type: "RUT", 
              number: '12345678'
          },
          address: {
              street_name: "Street",
              street_number: 123,
              zip_code: '5700'
          }
      },
      //notification_url: 'https://e2d1-190-107-20-98.ngrok.io/success',
      back_urls: {
          success: "http://localhost:3000/",
      }, 
      shipments: {
          receiver_address: { 
              zip_code: "5700",
              street_number: 123,
              street_name: "Street",
              floor: '4',
              apartment: "C"
          }
      },
  }
  const urlAccess = await mercadopago.preferences.create(preference)
    res.send({url: `https://sandbox.mercadopago.com.co/checkout/v1/modal?pref_id=${urlAccess.body.id}`})

  } catch (error) {
    next(error)
  }
})

// router.get("/", (req, res, next) => {

//   // Crea un objeto de preferencia
//   let preference = {
//     items: [
//       {
//         title: "Dummy Item",
//         description: "Multicolor Item",
//         currency_id: "$",
//         quantity: 1,
//         unit_price: 10,
//       },
//     ],
//     external_reference: `${id_orden}`, //`${new Date().valueOf()}`,
//     back_urls: {
//       success: "http://localhost:3001/mercadopago/pagos",
//       failure: "http://localhost:3001/mercadopago/pagos",
//       pending: "http://localhost:3001/mercadopago/pagos",
//     },
//   };
//   mercadopago.preferences
//     .create(preference)
//     .then(function (response) {
//       console.info("respondio");
//       // Este valor reemplazará el string"<%= global.id %>" en tu HTML
//       global.id = response.body.id;
//       console.log(response.body.items);
//       res.json({ id: global.id, init_point: response.body.init_point });
//     })
//     .catch(function (error) {
//       console.log(error);
//     });
// });

// server.get("/pagos/:id", (req, res) => {
//   const mp = new mercadopago(PROD_ACCESS_TOKEN);
//   const id = req.params.id;
//   console.info("Buscando el id", id);
//   mp.get(`/v1/payments/search`, { status: "pending" }) //{"external_reference":id})
//     .then((resultado) => {
//       console.info("resultado", resultado);
//       res.json({ resultado: resultado });
//     })
//     .catch((err) => {
//       console.error("No se consulto:", err);
//       res.json({
//         error: err,
//       });
//     });
// });

// server.get("/pagos", (req, res) => {
//   console.info("EN LA RUTA PAGOS ", req);
//   const payment_id = req.query.payment_id;
//   const payment_status = req.query.status;
//   const external_reference = req.query.external_reference;
//   const merchant_order_id = req.query.merchant_order_id;
//   console.log("EXTERNAL REFERENCE ", external_reference);

//   //Aquí edito el status de mi orden

//   Order.findByPk(external_reference)
//     .then((order) => {
//       order.payment_id = payment_id;
//       order.payment_status = payment_status;
//       order.merchant_order_id = merchant_order_id;
//       order.status = "created";
//       console.info("Salvando order");
//       order
//         .save()
//         .then((_) => {
//           console.info("redirect success");

//           return res.redirect("http://localhost:3000");
//         })
//         .catch((err) => {
//           console.error("error al salvar", err);
//           return res.redirect(
//             `http://localhost:3000/?error=${err}&where=al+salvar`
//           );
//         });
//     })
//     .catch((err) => {
//       console.error("error al buscar", err);
//       return res.redirect(
//         `http://localhost:3000/?error=${err}&where=al+buscar`
//       );
//     });

  //proceso los datos del pago
  // redirijo de nuevo a react con mensaje de exito, falla o pendiente
  //res.send(`${payment_id} ${payment_status} ${external_reference} ${merchant_order_id} `)
// });

module.exports = router;
